CREATE OR REPLACE PACKAGE PKG_DISCIPLINA AS

  -- Procedure para cadastro de disciplina
  PROCEDURE CADASTRAR_DISCIPLINA(p_nome IN VARCHAR2, p_descricao IN VARCHAR2, p_carga_horaria IN NUMBER);

  -- Cursor para total de alunos por disciplina
  CURSOR CURSOR_ALUNOS_POR_DISCIPLINA;

  -- Cursor parametrizado para média de idade por disciplina
  CURSOR CURSOR_MEDIA_IDADE_POR_DISCIPLINA(p_id_disciplina IN NUMBER);

  -- Procedure para listar alunos de uma disciplina
  PROCEDURE LISTAR_ALUNOS_DISCIPLINA(p_id_disciplina IN NUMBER);

END PKG_DISCIPLINA;
/

CREATE OR REPLACE PACKAGE BODY PKG_DISCIPLINA AS

  PROCEDURE CADASTRAR_DISCIPLINA(p_nome IN VARCHAR2, p_descricao IN VARCHAR2, p_carga_horaria IN NUMBER) IS
  BEGIN
    INSERT INTO DISCIPLINA (NOME, DESCRICAO, CARGA_HORARIA)
    VALUES (p_nome, p_descricao, p_carga_horaria);

    COMMIT;
  EXCEPTION
    WHEN OTHERS THEN
      ROLLBACK;
      RAISE;
  END CADASTRAR_DISCIPLINA;

  -- Cursor para total de alunos por disciplina
  CURSOR CURSOR_ALUNOS_POR_DISCIPLINA IS
    SELECT D.NOME AS NOME_DISCIPLINA, COUNT(M.ID_ALUNO) AS TOTAL_ALUNOS
    FROM DISCIPLINA D
    JOIN MATRICULA M ON D.ID_DISCIPLINA = M.ID_DISCIPLINA
    GROUP BY D.NOME
    HAVING COUNT(M.ID_ALUNO) > 10;

  -- Cursor parametrizado para média de idade por disciplina
  CURSOR CURSOR_MEDIA_IDADE_POR_DISCIPLINA(p_id_disciplina IN NUMBER) IS
    SELECT AVG(TRUNC(MONTHS_BETWEEN(SYSDATE, A.DATA_NASCIMENTO) / 12)) AS MEDIA_IDADE
    FROM ALUNO A
    JOIN MATRICULA M ON A.ID_ALUNO = M.ID_ALUNO
    WHERE M.ID_DISCIPLINA = p_id_disciplina;

  PROCEDURE LISTAR_ALUNOS_DISCIPLINA(p_id_disciplina IN NUMBER) IS
    CURSOR CURSOR_ALUNOS IS
      SELECT A.NOME
      FROM ALUNO A
      JOIN MATRICULA M ON A.ID_ALUNO = M.ID_ALUNO
      WHERE M.ID_DISCIPLINA = p_id_disciplina;
  BEGIN
    FOR REC IN CURSOR_ALUNOS LOOP
      DBMS_OUTPUT.PUT_LINE(REC.NOME);
    END LOOP;
  END LISTAR_ALUNOS_DISCIPLINA;

END PKG_DISCIPLINA;
/
